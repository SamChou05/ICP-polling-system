import { ic } from 'azle/src/lib/ic';
import { Void } from 'azle/src/lib/candid/types/primitive/void';
import { CanisterMethodInfo } from 'azle/src/lib/canister_methods/types/canister_method_info';
import { isAsync } from 'azle/src/lib/canister_methods/is_async';

export function heartbeat(
    callback: () => void | Promise<void>
): CanisterMethodInfo<[], Void> {
    return {
        mode: 'heartbeat',
        callback: () => executeHeartbeat(callback),
        paramCandidTypes: [],
        returnCandidType: Void,
        async: isAsync(callback),
        guard: undefined
    };
}

function executeHeartbeat(callback: any) {
    const result = callback();

    if (
        result !== undefined &&
        result !== null &&
        typeof result.then === 'function'
    ) {
        result.catch((error: any) => {
            ic.trap(error.toString());
        });
    }

    return;
}
